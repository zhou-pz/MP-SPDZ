from Compiler.library import *
from Compiler.sql.sequential_incre_proto import *

def Inserting_circuit_test():
    n = 1000000
    a = 3
    D = Matrix(a, n, sint)
    update_tuple = Array(a, sint)
    D = CDIC(update_tuple, D)
    # D = Optimized_CDIC(update_tuple, D)

def OrderBy_insert_test():
    # h = 1048576 # tuple number
    h = 8
    a = 4   # attribute number
    limit = 3   # limit size
    outOpt = False

    data = [
        [1, 1, 2, 2, 3, 3, 3, 1],
        [1, 1, 1, 1, 1, 1, 0, 0],
        [1, 2, 3, 4, 5, 6, 7, 8],
        [100, 200, 300, 400, 500, 600, 700, 800]
    ]
    D = Matrix(a, h, sint)
    D.assign(data)
    # D.read_from_file(0)
    print_ln('D:')
    D.print_reveal_nested(end='\n')

    update_tuple = Array(a, sint)
    update_tuple[0] = sint(1)
    update_tuple[1] = sint(1)
    update_tuple[2] = sint(10) # id
    update_tuple[3] = sint(1000)
    # print_ln('update_tuple:')
    # update_tuple.print_reveal_nested(end='\n')
    if outOpt == False:
        D, t_out1, t_out2 = OrderBy_insert(update_tuple, D, limit, outOpt)
    else:
        D = OrderBy_insert(update_tuple, D, limit, outOpt)

def OrderBy_delete_test():
    # h = 1000 # tuple number
    h = 8
    a = 3
    # a = 4   # attribute number
    limit = 3   # limit size
    outOpt = False

    data = [
        [1, 1, 2, 2, 3, 3, 3, 1],
        [1, 1, 1, 1, 1, 1, 0, 0],
        [1, 2, 3, 4, 5, 6, 7, 8]
    ]
    D = Matrix(a, h, sint)
    D.assign(data)
    # D.read_from_file(0)

    update_tuple = Array(a, sint)
    update_tuple[0] = sint(1)
    update_tuple[1] = sint(1)
    update_tuple[2] = sint(2) # id
    # print_ln('update_tuple:')
    # update_tuple.print_reveal_nested(end='\n')    
    if outOpt == False:
        D_dualprime, t_out1, t_out2 = OrderBy_delete(update_tuple, D, limit, outOpt)
    else:
        D_dualprime = OrderBy_delete(update_tuple, D, limit, outOpt)

def GroupBy_insert_test():
    n = 8
    a = 3
    outOpt = False

    data = [
        [1, 1, 2, 2, 3, 3, 3, 1],
        [1, 1, 1, 2, 3, 1, 1, 0],
        [0, 1, 0, 1, 1, 0, 0, 0]
    ]
    G = Matrix(a, n, sint)
    G.assign(data)
    update_tuple = Array(a, sint)
    update_tuple[0] = sint(2)
    update_tuple[1] = sint(10)
    update_tuple[2] = sint(1)
    if outOpt == False:
        G, t_u_out1, t_u_out2, t_u_out3 = GroupBy_insert(G, update_tuple, outOpt)
    else:
        G = GroupBy_insert(G, update_tuple, outOpt)

def GroupBy_delete_test():
    n = 8
    a = 3
    outOpt = False

    data = [
        [1, 1, 2, 2, 3, 3, 3, 1],
        [1, 1, 1, 2, 3, 1, 1, 0],
        [0, 1, 0, 1, 1, 0, 0, 0]
    ]
    G = Matrix(a, n, sint)
    G.assign(data)
    update_tuple = Array(a, sint)
    update_tuple[0] = sint(3)
    update_tuple[1] = sint(1)
    update_tuple[2] = sint(1)
    if outOpt == False:
        G, t_u_out1, t_u_out2 = GroupBy_delete(G, update_tuple, outOpt)
    else:
        G = GroupBy_delete(G, update_tuple, outOpt)

def Join_insert_test():
    a_A, n_A = 4, 5
    a_B, n_B = 5, 6
    a_J = a_A + a_B - 2
    n_J = n_A + n_B
    outOpt = False
    data_A = [
        [1, 1, 2, 3, 4],
        [0, 1, 1, 1, 1],
        [10, 10, 20, 30, 40],
        [100, 100, 200, 300, 400]
    ]
    data_B = [
        [1, 3, 4, 5, 4, 6],
        [1, 1, 1, 1, 0, 1],
        [11, 31, 41, 51, 41, 61],
        [111, 311, 411, 511, 411, 611],
        [1111, 3111, 4111, 5111, 4111, 6111],
    ]
    data_J = [
        [1, 1, 1, 3, 4, 2, 3, 5, 3, 5, 6],
        [0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0],
        [10, 10, 10, 30, 40, 20, 30, 50, 30, 50, 60],
        [100, 100, 100, 300, 400, 200, 300, 500, 300, 500, 600],
        [11, 11, 11, 31, 41, 21, 31, 51, 31, 51, 61],
        [111, 111, 111, 311, 411, 211, 311, 511, 311, 511, 611],
        [1111, 1111, 1111, 3111, 4111, 2111, 3111, 5111, 3111, 5111, 6111],
    ]
    A = Matrix(a_A, n_A, sint)
    A.assign(data_A)
    B = Matrix(a_B, n_B, sint)
    B.assign(data_B)
    J = Matrix(a_J, n_J, sint)
    J.assign(data_J)
    # update_tuple = Array(a_A, sint)
    # update_tuple[0] = sint(6)
    # update_tuple[1] = sint(1)
    # update_tuple[2] = sint(60)
    # update_tuple[3] = sint(600)
    # Join_insert(update_tuple, A, B, J, 'A')
    update_tuple = Array(a_B, sint)
    update_tuple[0] = sint(2)
    update_tuple[1] = sint(1)
    update_tuple[2] = sint(21)
    update_tuple[3] = sint(211)
    update_tuple[4] = sint(2111)
    if outOpt == False:
        A, B, J, t_u_out = Join_insert(update_tuple, A, B, J, 'B')
        print_ln("J:")
        J.transpose().print_reveal_nested(end='\n')
        print_ln("t_u_out:")
        t_u_out.print_reveal_nested(end='\n')
    else:
        A, B, J, _ = Join_insert(update_tuple, A, B, J, 'B')
        print_ln("J:")
        J.transpose().print_reveal_nested(end='\n')

def Join_delete_test():
    a_A, n_A = 4, 5
    a_B, n_B = 5, 6
    a_J = a_A + a_B - 2
    n_J = n_A + n_B
    outOpt = False
    data_A = [
        [1, 1, 2, 3, 4],
        [0, 1, 1, 1, 1],
        [10, 10, 20, 30, 40],
        [100, 100, 200, 300, 400]
    ]
    data_B = [
        [1, 3, 4, 5, 4, 6],
        [1, 1, 1, 1, 0, 1],
        [11, 31, 41, 51, 41, 61],
        [111, 311, 411, 511, 411, 611],
        [1111, 3111, 4111, 5111, 4111, 6111],
    ]
    data_J = [
        [1, 1, 1, 3, 4, 2, 3, 5, 3, 5, 6],
        [0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0],
        [10, 10, 10, 30, 40, 20, 30, 50, 30, 50, 60],
        [100, 100, 100, 300, 400, 200, 300, 500, 300, 500, 600],
        [11, 11, 11, 31, 41, 21, 31, 51, 31, 51, 61],
        [111, 111, 111, 311, 411, 211, 311, 511, 311, 511, 611],
        [1111, 1111, 1111, 3111, 4111, 2111, 3111, 5111, 3111, 5111, 6111],
    ]
    A = Matrix(a_A, n_A, sint)
    A.assign(data_A)
    B = Matrix(a_B, n_B, sint)
    B.assign(data_B)
    J = Matrix(a_J, n_J, sint)
    J.assign(data_J)
    update_tuple = Array(a_B, sint)
    update_tuple[0] = sint(3)
    update_tuple[1] = sint(1)
    update_tuple[2] = sint(31)
    update_tuple[3] = sint(311)
    update_tuple[4] = sint(3111)
    if outOpt == False:
        A, B, J, t_u_out = Join_delete(update_tuple, A, B, J, 'B', outOpt)
    else:
        A, B, J, _ = Join_delete(update_tuple, A, B, J, 'B', outOpt)

def Selection_insert_test():
    data = [
        [0, 1, 1, 1, 0],
        [1, 2, 3, 4, 5],
        [1, 20, 30, 40, 5]
    ]
    data_updates = [
        [1, 1],
        [6, 7],
        [10, 20]
    ]
    a, n = 3, 5
    n_updates = 2
    S = Matrix(a, n, sint)
    S.assign(data)
    update_rows = Matrix(a, n_updates, sint)
    update_rows.assign(data_updates)
    S, t_u_outs = Selection_insert(S, update_rows)
    print_ln("S after insertion:")
    S.transpose().print_reveal_nested(end='\n')
    print_ln("t_u_outs:")
    t_u_outs.transpose().print_reveal_nested(end='\n')

def Selection_delete_test():
    data = [
        [0, 1, 1, 1, 0],
        [1, 2, 3, 4, 5],
        [1, 20, 30, 40, 5]
    ]
    data_updates = [1, 3, 30]
    a, n = 3, 5
    S = Matrix(a, n, sint)
    S.assign(data)
    update_row = Array(a, sint)
    update_row.assign(data_updates)
    S = Selection_delete(S, update_row)
    print_ln("S after deletion:")
    S.transpose().print_reveal_nested(end='\n')

def Aggregation_insert_test():
    res = sint(4)
    n_values = 4
    values = Array(n_values, sint).assign([1, 2, 3])
    res_new = Aggregation_insert(res, values, 'max')
    print_ln("res: %s", res.reveal())
    print_ln("res_new: %s", reveal(res_new))

def Aggregation_delete_test():
    res = sint(6)
    n_values = 4
    values = Array(n_values, sint).assign([1, 2, 0])
    res_new = Aggregation_delete(res, values)
    print_ln("res: %s", res.reveal())
    print_ln("res_new: %s", reveal(res_new))

Inserting_circuit_test()
# OrderBy_insert_test()
# OrderBy_delete_test()
# GroupBy_insert_test()
# GroupBy_delete_test()
# Join_insert_test()
# Join_delete_test()
# Selection_insert_test()
# Selection_delete_test()
# Aggregation_insert_test()
# Aggregation_delete_test()

# v = sint(1)
# k = sint(2)
# result = (v << shift_length) + k
# print_ln("result: %s", result.reveal())
# print_ln("Noting! The supported maximum value of key is 2^%s - 1!\n", shift_length)