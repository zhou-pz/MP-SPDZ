from Compiler.library import *
from Compiler.sql.batch_incre_proto import *

def set_dummies_test():
    data_T_id = [1, 2, 3, 4, 5, 5]
    data_T_valid = [1, 1, 1, 1, 1, 0]
    data_update_id = [2, 5]
    data_update_valid = [1, 1]
    n = 6
    n_updates = 2
    T_id = Array(n, sint)
    T_valid = Array(n, sint)
    update_rows_id = Array(n_updates, sint)
    update_rows_valid = Array(n_updates, sint)
    T_id.assign(data_T_id)
    T_valid.assign(data_T_valid)
    update_rows_id.assign(data_update_id)
    update_rows_valid.assign(data_update_valid)
    T_valid, _ = set_dummies(T_id, T_valid, update_rows_id, update_rows_valid)
    T_valid.print_reveal_nested("\n")

def Orderby_batch_delete_test():
    h = 8
    a = 4
    limit = 4
    outOpt = False
    data_D = [
        [1, 1, 2, 2, 3, 3, 3, 1],
        [1, 1, 1, 1, 1, 1, 0, 0],
        [1, 2, 3, 4, 5, 6, 7, 8],
        [10, 20, 30, 40, 50, 60, 70, 80]
    ]
    data_updates = [
        [1, 3, 2],
        [1, 0, 1],
        [1, 5, 3],
        [10, 50, 30]
    ]
    D = Matrix(a, h, sint)
    D.assign(data_D)
    print_ln("D before deletions:")
    D.transpose().print_reveal_nested(end='\n')
    k = 3
    update_rows = Matrix(a, k, sint)
    update_rows.assign(data_updates)
    if outOpt == False:
        D, t_outs_ins, t_outs_del = Orderby_batch_delete(D, update_rows, limit, outOpt)
        print_ln("D after deletions:")
        D.print_reveal_nested(end='\n')
        print_ln("t_outs_ins:")
        t_outs_ins.transpose().print_reveal_nested(end='\n') # type: ignore
        print_ln("t_outs_del:")
        t_outs_del.transpose().print_reveal_nested(end='\n') # type: ignore
    else:
        D, _, _ = Orderby_batch_delete(D, update_rows, limit, outOpt)

def Groupby_batch_test():
    data = [
        [1, 1, 2, 2, 3, 3, 3, 1],
        [1, 1, 1, 2, 3, 1, 1, 0],
        [0, 1, 0, 1, 1, 0, 0, 0]
    ]
    data_updates = [
        [2, 3, 2, 3],
        [2, 3, 1, 1],
        [1, 1, 1, 0]
    ]
    update_manners = [0, 0, 1, 1]
    a, n = 3, 8
    n_updates = 4
    G = Matrix(a, n, sint)
    G.assign(data)
    update_rows = Matrix(a, n_updates, sint)
    update_rows.assign(data_updates)
    outOpt = False
    print_ln("G:")
    G.transpose().print_reveal_nested(end='\n')
    print_ln("update_rows:")
    update_rows.transpose().print_reveal_nested(end='\n')
    if outOpt:
        G, _, _ = Groupby_batch(G, update_rows, update_manners, outOpt)
        print_ln("G after updates:")
        G.transpose().print_reveal_nested(end='\n')
    else:
        G, t_outs_ins, t_outs_del = Groupby_batch(G, update_rows, update_manners, outOpt)
        print_ln("G after updates:")
        G.transpose().print_reveal_nested(end='\n')
        print_ln("t_outs_ins:")
        t_outs_ins.transpose().print_reveal_nested(end='\n') # type: ignore
        print_ln("t_outs_del:")
        t_outs_del.transpose().print_reveal_nested(end='\n') # type: ignore

def Join_batch_delete_test():
    a_A, n_A = 4, 5
    a_B, n_B = 5, 6
    a_J = a_A + a_B - 2
    n_J = n_A + n_B
    outOpt = False
    data_A = [
        [1, 1, 2, 3, 4],
        [0, 1, 1, 1, 1],
        [10, 10, 20, 30, 40],
        [100, 100, 200, 300, 400]
    ]
    data_B = [
        [1, 3, 4, 5, 4, 6],
        [1, 1, 1, 1, 0, 1],
        [11, 31, 41, 51, 41, 61],
        [111, 311, 411, 511, 411, 611],
        [1111, 3111, 4111, 5111, 4111, 6111],
    ]
    data_J = [
        [1, 1, 1, 3, 4, 2, 3, 5, 3, 5, 6],
        [0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0],
        [10, 10, 10, 30, 40, 20, 30, 50, 30, 50, 60],
        [100, 100, 100, 300, 400, 200, 300, 500, 300, 500, 600],
        [11, 11, 11, 31, 41, 21, 31, 51, 31, 51, 61],
        [111, 111, 111, 311, 411, 211, 311, 511, 311, 511, 611],
        [1111, 1111, 1111, 3111, 4111, 2111, 3111, 5111, 3111, 5111, 6111],
    ]
    A = Matrix(a_A, n_A, sint)
    A.assign(data_A)
    B = Matrix(a_B, n_B, sint)
    B.assign(data_B)
    J = Matrix(a_J, n_J, sint)
    J.assign(data_J)
    data_updates = [
        [2, 4, 3],
        [1, 1, 1],
        [20, 40, 30],
        [200, 400, 300]
    ]
    k = 3
    update_rows = Matrix(a_A, k, sint)
    update_rows.assign(data_updates)
    if outOpt:
        A, B, J, _ = Join_batch_delete(A, B, J, update_rows, 'A', outOpt)
    else:
        A, B, J, t_outs = Join_batch_delete(A, B, J, update_rows, 'A', outOpt)
        print_ln("A after deletions:")
        A.transpose().print_reveal_nested(end='\n')
        print_ln("B after deletions:")
        B.transpose().print_reveal_nested(end='\n')
        print_ln("J after deletions:")
        J.transpose().print_reveal_nested(end='\n')
        print_ln("t_outs:")
        t_outs.transpose().print_reveal_nested(end='\n') # type: ignore
    # data_updates = [
    #     [1, 4, 5],
    #     [1, 1, 0],
    #     [11, 41, 51],
    #     [111, 411, 511,],
    #     [1111, 4111, 5111]
    # ]
    # k = 3
    # update_rows = Matrix(a_B, k, sint)
    # update_rows.assign(data_updates)
    # if outOpt:
    #     A, B, J, _ = Join_batch_delete(A, B, J, update_rows, 'B', outOpt)
    # else:
    #     A, B, J, t_outs = Join_batch_delete(A, B, J, update_rows, 'B', outOpt)
    #     print_ln("A after deletions:")
    #     A.transpose().print_reveal_nested(end='\n')
    #     print_ln("B after deletions:")
    #     B.transpose().print_reveal_nested(end='\n')
    #     print_ln("J after deletions:")
    #     J.transpose().print_reveal_nested(end='\n')
    #     print_ln("t_outs:")
    #     t_outs.transpose().print_reveal_nested(end='\n') # type: ignore

def Selection_insert_test():
    data = [
        [0, 1, 1, 1, 0],
        [1, 2, 3, 4, 5],
        [1, 20, 30, 40, 5]
    ]
    data_updates = [
        [1, 1],
        [6, 7],
        [10, 20]
    ]
    a, n = 3, 5
    n_updates = 2
    S = Matrix(a, n, sint)
    S.assign(data)
    update_rows = Matrix(a, n_updates, sint)
    update_rows.assign(data_updates)
    S, t_u_outs = Selection_batch_insert(S, update_rows)
    print_ln("S after insertion:")
    S.transpose().print_reveal_nested(end='\n')
    print_ln("t_u_outs:")
    t_u_outs.transpose().print_reveal_nested(end='\n')

def Selection_delete_test():
    data = [
        [0, 1, 1, 1, 1],
        [5, 2, 3, 4, 5],
        [5, 20, 30, 40, 5]
    ]
    data_updates = [
        [1, 1],
        [3, 5],
        [30, 5]
    ]
    a, n = 3, 5
    n_updates = 2
    S = Matrix(a, n, sint)
    S.assign(data)
    update_rows = Matrix(a, n_updates, sint)
    update_rows.assign(data_updates)
    S = Selection_batch_delete(S, update_rows)
    print_ln("S after insertion:")
    S.transpose().print_reveal_nested(end='\n')

def Aggregation_insert_test():
    res = sint(4)
    n_values = 4
    values = Array(n_values, sint).assign([1, 2, 3])
    res_new = Aggregation_batch_insert(res, values, 'max')
    print_ln("res: %s", res.reveal())
    print_ln("res_new: %s", reveal(res_new))

def Aggregation_delete_test():
    res = sint(6)
    n_values = 4
    values = Array(n_values, sint).assign([1, 2, 0])
    res_new = Aggregation_batch_delete(res, values)
    print_ln("res: %s", res.reveal())
    print_ln("res_new: %s", reveal(res_new))

Groupby_batch_test()